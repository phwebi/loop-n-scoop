pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
circ_orig = 63
circ_r = 59

p_sprite_start=16
p_sprite_end=20
anim_wait=2
angular_speed = .005
aim_speed = 0.002

p_leap_sprite_start = 32
p_leap_sprite_end = 33
leap_speed = 2

local moving, aiming, leaping = 0, 1, 2

p = {}
p.x = 0
p.y = 0
p.state = moving
p.aim_speed = aim_speed
p.aim = 0
p.sprite = p_sprite_start
p.timer = 0
p.flip = false
p.ccw = false

function _init()
  -- draw black pixels
  palt(0, false)
 
  -- don't draw red pixels
  palt(8, true)

  p.x, p.y = ang_to_pl_coord(0)
end

function pl_coord_centered()
  return p.x + 3, p.y + 3
end

function ang_to_pl_coord(angle)
  x_centered=circ_orig + circ_r * cos(angle)
  y_centered=circ_orig + circ_r * sin(angle)

  return x_centered - 3, y_centered - 3
end

function pl_coord_to_ang(x, y)
  return atan2(x - circ_orig, y - circ_orig)
end

function min_aim_angle() -- 90 deg aim range
  x, y = pl_coord_centered()
  return atan2(circ_orig - x, circ_orig - y) - 0.125
end

function max_aim_angle() -- 90 deg aim range
  return min_aim_angle() + 0.25
end

function is_on_circle(x, y)
  d = sqrt((x - circ_orig)*(x - circ_orig) + (y - circ_orig)*(y - circ_orig))
  printh(d)
  return abs(d - circ_r) < 1
end

function animate_player(sprite_start, sprite_end)
  p.timer+=1

  if p.timer > anim_wait then
    p.sprite+=1
    p.timer = 0
  end

  if p.sprite > sprite_end then
    p.sprite = sprite_start
  end
end

function handle_player_movement()
  updated = false
  angle = pl_coord_to_ang(pl_coord_centered())

  if (btn(0)) then
    angle+=angular_speed
    if angle > 1 then angle = 0 end
    
    p.ccw = true
    updated = true
  elseif (btn(1)) then
    if angle == 0 then angle = 1 end
    angle-=angular_speed
    if angle < 0 then angle = 1 end

    p.ccw = false
    updated = true
  end

  if not updated then return end
  
  animate_player(p_sprite_start, p_sprite_end)

  p.x, p.y = ang_to_pl_coord(angle)
  p.flip =
    (p.y > circ_orig and not p.ccw) or
    (p.y <= circ_orig and p.ccw)
end

function setup_aim()
  p.state = aiming
  p.aim = min_aim_angle()
  p.aim_speed = aim_speed
end

function _update()
  if (p.state == moving) then
    handle_player_movement()

    if btnp(4) then setup_aim() end -- press z to aim
  elseif (p.state == aiming) then
    if btnp(5) then -- press x to cancel
      p.state = moving
    elseif btnp(4) then -- press z to confirm
      p.state = leaping
      p.sprite = p_leap_sprite_start
    else -- update cursor
      p.aim += p.aim_speed

      if (p.aim > max_aim_angle()) or (p.aim < min_aim_angle()) then
        p.aim_speed = -p.aim_speed
      end
    end
  elseif (p.state == leaping) then
    -- update player location
    p.x += leap_speed * cos(p.aim)
    p.y += leap_speed * sin(p.aim)

    if is_on_circle(pl_coord_centered()) then
      p.state = moving
      p.sprite = p_sprite_start
      p.timer = 0
    else
      animate_player(p_leap_sprite_start, p_leap_sprite_end)
    end
  end
end

function _draw()
  map(0,0,0,0,16,16)
  circfill(circ_orig,circ_orig,55,1)
  circ(circ_orig, circ_orig, 55, 6)

  spr(p.sprite,p.x,p.y,1,1,p.flip) 

  if p.state == aiming then
    aim_x=p.x + 200 * cos(p.aim)
    aim_y=p.y + 200 * sin(p.aim)
    x, y = pl_coord_centered()
    line(x, y, aim_x, aim_y, 8)
  end
end
__gfx__
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000767777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777767770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888888888888888888888888888888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88dd558888dd558888dd558888dd558888dd55880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8dddd5588dddd5588dddd5588dddd5588dddd5580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8dd070588dd070588dd070588dd070588dd070580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8de797288de797288de797288de797288de797280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8dd777588dd777448dd77744899777588d9977580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8d9977448d997758899777588dd777448dd777440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
86666668866666688666666886666668866666680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88dd558888dd55880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8dddd5588dddd5580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8dd070588dd070580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8de79728dde797250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddd777558dd777580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8d9974488d9974480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
