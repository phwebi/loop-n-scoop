pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- map
circ_orig = 63
circ_r = 59

-- player
p_sprite_start=16
p_sprite_end=20
anim_wait=2
angular_speed = .005
aim_speed = 0.002

p_leap_sprite_start = 32
p_leap_sprite_end = 33
leap_speed = 2

local moving, aiming, leaping = 0, 1, 2

p = {}
p.x = 0
p.y = 0
p.state = moving
p.aim_speed = aim_speed
p.aim = 0
p.sprite = p_sprite_start
p.timer = 0
p.flip = false
p.ccw = false

-- pickups
pickup_sprites_start = 2
pickup_sprites_end = 8

function _init()
  -- draw black pixels
  palt(0, false)
 
  -- don't draw light blue pixels
  palt(12, true)

  p.x, p.y = ang_to_pl_coord(0)

  pickup = {}
  add_pickup()
end

function add_pickup()
  local pick = {}
  pick.sprite = flr(rnd(pickup_sprites_end - pickup_sprites_start)) + pickup_sprites_start
  
  r = (circ_r - 10) * sqrt(rnd(1))
  theta = rnd(1) * 2 * 3.14159
  pick.x = circ_orig + r * cos(theta)
  pick.y = circ_orig + r * sin(theta)

  add(pickup, pick)
end

function pl_coord_centered()
  return p.x + 3, p.y + 3
end

function ang_to_pl_coord(angle)
  x_centered=circ_orig + circ_r * cos(angle)
  y_centered=circ_orig + circ_r * sin(angle)

  return x_centered - 3, y_centered - 3
end

function pl_coord_to_ang(x, y)
  return atan2(x - circ_orig, y - circ_orig)
end

function min_aim_angle() -- 90 deg aim range
  x, y = pl_coord_centered()
  return atan2(circ_orig - x, circ_orig - y) - 0.125
end

function max_aim_angle() -- 90 deg aim range
  return min_aim_angle() + 0.25
end

function is_on_circle(x, y)
  d = sqrt((x - circ_orig)*(x - circ_orig) + (y - circ_orig)*(y - circ_orig))
  return abs(d - circ_r) < 1
end

function animate_player(sprite_start, sprite_end)
  p.timer+=1

  if p.timer > anim_wait then
    p.sprite+=1
    p.timer = 0
  end

  if p.sprite > sprite_end then
    p.sprite = sprite_start
  end
end

function handle_player_movement()
  updated = false
  angle = pl_coord_to_ang(pl_coord_centered())

  if (btn(0)) then
    angle+=angular_speed
    if angle > 1 then angle = 0 end
    
    p.ccw = true
    updated = true
  elseif (btn(1)) then
    if angle == 0 then angle = 1 end
    angle-=angular_speed
    if angle < 0 then angle = 1 end

    p.ccw = false
    updated = true
  end

  if not updated then return end
  
  animate_player(p_sprite_start, p_sprite_end)

  p.x, p.y = ang_to_pl_coord(angle)
  p.flip =
    (p.y > circ_orig and not p.ccw) or
    (p.y <= circ_orig and p.ccw)
end

function setup_aim()
  p.state = aiming
  p.aim = min_aim_angle()
  p.aim_speed = aim_speed
end

function _update()
  if (p.state == moving) then
    handle_player_movement()

    if btnp(4) then setup_aim() end -- press z to aim
  elseif (p.state == aiming) then
    if btnp(5) then -- press x to cancel
      p.state = moving
    elseif btnp(4) then -- press z to confirm
      p.state = leaping
      p.sprite = p_leap_sprite_start
    else -- update cursor
      p.aim += p.aim_speed

      if (p.aim > max_aim_angle()) or (p.aim < min_aim_angle()) then
        p.aim_speed = -p.aim_speed
      end
    end
  elseif (p.state == leaping) then
    -- update player location
    p.x += leap_speed * cos(p.aim)
    p.y += leap_speed * sin(p.aim)

    if is_on_circle(pl_coord_centered()) then
      p.state = moving
      p.sprite = p_sprite_start
      p.timer = 0
    else
      animate_player(p_leap_sprite_start, p_leap_sprite_end)
    end
  end
end

function draw_actor(a)
  spr(a.sprite,a.x,a.y) 
end

function _draw()
  map(0,0,0,0,16,16)
  circfill(circ_orig,circ_orig,55,1)
  circ(circ_orig, circ_orig, 55, 6)

  -- spr(ice_sprite, 63, 63)
  foreach(pickup, draw_actor)

  spr(p.sprite,p.x,p.y,1,1,p.flip) 

  if p.state == aiming then
    aim_x=p.x + 200 * cos(p.aim)
    aim_y=p.y + 200 * sin(p.aim)
    x, y = pl_coord_centered()
    line(x, y, aim_x, aim_y, 8)
  end
end
__gfx__
0000000077777777ccceeeccccc999cccccdddccccc444cccccfffccccc333ccccc888cc00000000000000000000000000000000000000000000000000000000
0000000077777767cceef7eccc99a79cccdd67dccc44f74cccffa7fccc33b73ccc88e78c00000000000000000000000000000000000000000000000000000000
0070070077777777ceeeef7ec9999a79cdddd67dc4444f74cffffa7fc3333b73c8888e7800000000000000000000000000000000000000000000000000000000
0007700077777777c2eeeefec49999a9c2dddd6dc24444f4c4ffffafc03333b3c28888e800000000000000000000000000000000000000000000000000000000
0007700076777777c22eeeeec4499999c22dddddc2244444c44fffffc0033333c228888800000000000000000000000000000000000000000000000000000000
0070070077777777cc222eeccc44499ccc222ddccc22244ccc444ffccc00033ccc22288c00000000000000000000000000000000000000000000000000000000
0000000077776777c222eeeec4449999c222ddddc2224444c444ffffc0003333c222888800000000000000000000000000000000000000000000000000000000
0000000077777777cccccccccccccccccccccccccccccccccccccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccdd55ccccdd55ccccdd55ccccdd55ccccdd55cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cdddd55ccdddd55ccdddd55ccdddd55ccdddd55c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cdd0705ccdd0705ccdd0705ccdd0705ccdd0705c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cde7972ccde7972ccde7972ccde7972ccde7972c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cdd7775ccdd77744cdd77744c997775ccd99775c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cd997744cd99775cc997775ccdd77744cdd777440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c666666cc666666cc666666cc666666cc666666c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccdd55ccccdd55cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cdddd55ccdddd55c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cdd0705ccdd0705c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cde7972cdde797250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddd77755cdd7775c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cd99744ccd99744c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
